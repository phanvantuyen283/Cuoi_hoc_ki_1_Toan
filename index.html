<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Thi To√°n L·ªõp 4 - EduMath</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Lexend', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .quiz-card { background: white; border-radius: 1.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05); border: 1px solid #e2e8f0; }
        .q-box { border-left: 6px solid #3b82f6; background-color: #f8fafc; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem; }
        .option-item { display: flex; align-items: center; gap: 12px; padding: 12px; border: 2px solid #f1f5f9; border-radius: 12px; cursor: pointer; transition: all 0.2s; margin-top: 8px; }
        .option-item:hover { border-color: #93c5fd; background-color: #eff6ff; }
        input[type="radio"]:checked + span { color: #2563eb; font-weight: 700; }
        .sticky-nav { position: sticky; top: 0; z-index: 50; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid #e2e8f0; }
        .btn-tab { padding: 8px 16px; border-radius: 10px; font-weight: 600; font-size: 14px; transition: all 0.2s; }
        .btn-tab.active { background: white; color: #2563eb; shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .btn-tab:not(.active) { color: #64748b; }
    </style>
</head>
<body>

    <!-- Navigation -->
    <nav class="sticky-nav p-4">
        <div class="max-w-5xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 p-2 rounded-xl text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1-2.5-2.5Z"/><path d="M8 7h6"/><path d="M8 11h8"/></svg>
                </div>
                <h1 class="text-xl font-extrabold text-slate-800 tracking-tight">EduMath L·ªõp 4</h1>
            </div>
            
            <div class="flex bg-slate-100 p-1 rounded-xl border">
                <button onclick="switchView('student')" id="tab-student" class="btn-tab active">H·ªçc sinh</button>
                <button onclick="switchView('results')" id="tab-results" class="btn-tab">Tra c·ª©u</button>
                <button onclick="switchView('admin')" id="tab-admin" class="btn-tab">Gi√°o vi√™n</button>
            </div>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto p-4 md:p-8">

        <!-- VIEW 1: STUDENT (L√ÄM B√ÄI) -->
        <div id="view-student" class="view-content animate-in fade-in duration-500">
            <header class="text-center mb-10">
                <h2 class="text-3xl font-black text-blue-700 uppercase tracking-tight">Ki·ªÉm Tra H·ªçc K·ª≥ I</h2>
                <div id="timer-box" class="mt-4 inline-flex items-center gap-3 bg-red-100 text-red-600 px-8 py-2 rounded-full font-black text-2xl border-2 border-red-200">
                    <span id="timer-display">40:00</span>
                </div>
            </header>

            <div class="quiz-card p-6 mb-8 border-t-8 border-blue-500">
                <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2">üë§ TH√îNG TIN C·ª¶A EM</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="s-name" placeholder="H·ªç v√† t√™n..." class="w-full border-2 border-slate-100 rounded-xl p-3 focus:border-blue-500 outline-none transition">
                    <input type="text" id="s-class" placeholder="L·ªõp (V√≠ d·ª•: 4B)..." class="w-full border-2 border-slate-100 rounded-xl p-3 focus:border-blue-500 outline-none transition">
                </div>
            </div>

            <form id="quiz-form" class="space-y-8 pb-20">
                <!-- MCQ -->
                <div class="bg-blue-600 text-white inline-block px-6 py-2 rounded-t-2xl font-black shadow-md uppercase text-sm">Ph·∫ßn I: Tr·∫Øc Nghi·ªám</div>
                <div class="quiz-card p-6 border-2 border-blue-50 space-y-2">
                    <div class="q-box">
                        <p class="font-bold text-slate-800">C√¢u 1. Gi√° tr·ªã c·ªßa ch·ªØ s·ªë 8 trong s·ªë 28 471 539 l√†:</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-4">
                            <label class="option-item"><input type="radio" name="q1" value="A"><span>A. 80 000</span></label>
                            <label class="option-item"><input type="radio" name="q1" value="B"><span>B. 8 000 000</span></label>
                            <label class="option-item"><input type="radio" name="q1" value="C"><span>C. 80 000 000</span></label>
                            <label class="option-item"><input type="radio" name="q1" value="D"><span>D. 800 000</span></label>
                        </div>
                    </div>
                    <div class="q-box">
                        <p class="font-bold text-slate-800">C√¢u 2. T·ªïng l√† 100, hi·ªáu l√† 20. S·ªë l·ªõn l√†:</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-4">
                            <label class="option-item"><input type="radio" name="q2" value="A"><span>A. 40</span></label>
                            <label class="option-item"><input type="radio" name="q2" value="B"><span>B. 60</span></label>
                        </div>
                    </div>
                    <div class="q-box">
                        <p class="font-bold text-slate-800">C√¢u 6. Trung b√¨nh c·ªông c·ªßa 999 v√† 9999 l√†:</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-4">
                            <label class="option-item"><input type="radio" name="q6" value="A"><span>A. 5499</span></label>
                            <label class="option-item"><input type="radio" name="q6" value="B"><span>B. 5473</span></label>
                        </div>
                    </div>
                </div>

                <!-- Essay -->
                <div class="bg-emerald-600 text-white inline-block px-6 py-2 rounded-t-2xl font-black shadow-md uppercase text-sm">Ph·∫ßn II: T·ª± Lu·∫≠n</div>
                <div class="quiz-card p-6 border-2 border-emerald-50">
                    <div class="q-box" style="border-left-color: #10b981;">
                        <p class="font-bold text-slate-800">C√¢u 9. B√†i to√°n HCN c√≥ n·ª≠a chu vi 180m, hi·ªáu d√†i-r·ªông l√† 24m. T√≠nh di·ªán t√≠ch:</p>
                        <textarea id="s-essay" class="w-full mt-4 p-4 border-2 rounded-2xl h-48 focus:border-emerald-500 outline-none transition" placeholder="Em tr√¨nh b√†y l·ªùi gi·∫£i chi ti·∫øt c·ªßa em v√†o ƒë√¢y..."></textarea>
                    </div>
                </div>

                <button type="button" onclick="submitExam()" id="submit-btn" class="w-full bg-blue-600 text-white font-black py-5 rounded-3xl text-2xl shadow-xl hover:scale-[1.02] transition active:scale-95">üöÄ N·ªòP B√ÄI THI</button>
            </form>
        </div>

        <!-- VIEW 2: RESULTS (TRA C·ª®U) -->
        <div id="view-results" class="view-content hidden py-10 animate-in slide-in-from-bottom duration-500">
            <div class="max-w-md mx-auto">
                <div class="quiz-card p-8 border-t-8 border-indigo-500">
                    <h2 class="text-2xl font-black text-indigo-700 text-center mb-6 uppercase">Tra c·ª©u k·∫øt qu·∫£</h2>
                    <div class="flex gap-2 mb-8">
                        <input type="text" id="search-name" placeholder="Nh·∫≠p t√™n em..." class="flex-grow p-4 border-2 rounded-2xl outline-none focus:border-indigo-500">
                        <button onclick="searchMyScore()" class="bg-indigo-600 text-white p-4 rounded-2xl">üîç</button>
                    </div>
                    <div id="search-output" class="hidden space-y-4">
                        <div class="bg-slate-50 p-6 rounded-2xl border text-center">
                            <h3 id="res-name" class="text-xl font-bold mb-4">...</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-white p-3 rounded-xl border shadow-sm">
                                    <p class="text-[10px] font-bold text-slate-400 uppercase">Tr·∫Øc nghi·ªám</p>
                                    <p id="res-mcq" class="text-2xl font-black text-blue-600">0/3.0</p>
                                </div>
                                <div class="bg-white p-3 rounded-xl border shadow-sm">
                                    <p class="text-[10px] font-bold text-slate-400 uppercase">T·ª± lu·∫≠n</p>
                                    <p id="res-essay" class="text-2xl font-black text-emerald-600">?</p>
                                </div>
                            </div>
                            <div id="res-comment" class="mt-4 bg-white p-4 rounded-xl text-sm italic text-slate-500 border">...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 3: ADMIN (GI√ÅO VI√äN) -->
        <div id="view-admin" class="view-content hidden animate-in fade-in duration-500">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-black text-slate-800 uppercase tracking-tight">Danh s√°ch b√†i n·ªôp</h2>
                <div class="text-xs font-bold text-emerald-500 bg-emerald-50 px-3 py-1 rounded-full border border-emerald-100">‚óè Live Connection</div>
            </div>
            
            <div class="quiz-card overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 border-b text-xs font-black text-slate-500 uppercase tracking-widest">
                        <tr>
                            <th class="p-4">H·ªçc sinh</th>
                            <th class="p-4">L·ªõp</th>
                            <th class="p-4">ƒêi·ªÉm TN</th>
                            <th class="p-4">Tr·∫°ng th√°i</th>
                            <th class="p-4">Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="admin-table" class="divide-y divide-slate-100">
                        <!-- JS injected -->
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <!-- Modal ch·∫•m ƒëi·ªÉm -->
    <div id="grading-modal" class="fixed inset-0 bg-slate-900/60 hidden z-[100] items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-xl rounded-3xl shadow-2xl overflow-hidden animate-in zoom-in duration-300">
            <div class="bg-slate-800 p-6 text-white flex justify-between items-center">
                <h3 id="grade-title" class="text-xl font-bold">Ch·∫•m b√†i</h3>
                <button onclick="closeGradeModal()" class="text-slate-400 hover:text-white">‚úï</button>
            </div>
            <div class="p-8">
                <p class="text-xs font-bold text-slate-400 uppercase mb-2">B√†i l√†m t·ª± lu·∫≠n:</p>
                <div id="grade-content" class="bg-slate-50 p-4 rounded-2xl border text-sm italic mb-6 max-h-40 overflow-y-auto"></div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase">ƒêi·ªÉm (0-7):</label>
                        <input type="number" id="grade-value" step="0.25" class="w-full p-4 bg-blue-50 border-2 rounded-2xl font-black text-blue-700 outline-none">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase">L·ªùi ph√™:</label>
                        <input type="text" id="grade-comment" class="w-full p-4 border-2 rounded-2xl outline-none" placeholder="L√†m b√†i t·ªët...">
                    </div>
                </div>
                <button onclick="saveFinalGrade()" id="btn-save" class="w-full mt-8 bg-blue-600 text-white font-black py-4 rounded-2xl shadow-lg hover:bg-blue-700 transition">üíæ L∆ØU ƒêI·ªÇM V√Ä PH·∫¢N H·ªíI</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (Version 11.6.1) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Kh·ªüi t·∫°o Firebase
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'toan-4-hk1-online';

        let user = null;
        let activeGradingId = null;

        // X√°c th·ª±c
        const initAuth = async () => {
            await signInAnonymously(auth);
            onAuthStateChanged(auth, (u) => { user = u; if(u) listenForData(); });
        };
        initAuth();

        // Chuy·ªÉn view
        window.switchView = (view) => {
            document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
            document.getElementById('view-' + view).classList.remove('hidden');
            
            document.querySelectorAll('.btn-tab').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + view).classList.add('active');
        };

        // Timer
        let timeLeft = 40 * 60;
        setInterval(() => {
            if(document.getElementById('view-student').classList.contains('hidden')) return;
            timeLeft--;
            const m = Math.floor(timeLeft/60);
            const s = timeLeft%60;
            document.getElementById('timer-display').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
            if(timeLeft <= 0) { alert("H·∫øt gi·ªù!"); submitExam(); }
        }, 1000);

        // N·ªòP B√ÄI
        window.submitExam = async () => {
            const name = document.getElementById('s-name').value.trim();
            const cls = document.getElementById('s-class').value.trim();
            if(!name || !cls) return alert("Vui l√≤ng nh·∫≠p t√™n v√† l·ªõp!");

            const btn = document.getElementById('submit-btn');
            btn.disabled = true; btn.innerText = "üåÄ ƒêANG G·ª¨I B√ÄI...";

            const form = document.getElementById('quiz-form');
            const fd = new FormData(form);
            const keys = { q1: 'B', q2: 'B', q6: 'A' };
            let mcq = 0;
            for(let k in keys) if(fd.get(k) === keys[k]) mcq += 1;

            const sub = {
                name, class: cls,
                mcqScore: (mcq/3)*3, // V√≠ d·ª• 3 c√¢u m·∫´u
                essay: document.getElementById('s-essay').value,
                status: 'Ch·ªù ch·∫•m',
                createdAt: serverTimestamp()
            };

            try {
                if(!user) await signInAnonymously(auth);
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'submissions'), sub);
                alert("N·ªôp b√†i th√†nh c√¥ng! Em h√£y sang tab TRA C·ª®U ƒë·ªÉ xem k·∫øt qu·∫£.");
                location.reload();
            } catch(e) { alert("L·ªói g·ª≠i b√†i!"); btn.disabled = false; }
        };

        // TRA C·ª®U
        window.searchMyScore = async () => {
            const keyword = document.getElementById('search-name').value.trim();
            if(!keyword) return;
            
            const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'submissions'));
            const res = snap.docs.find(d => d.data().name.toLowerCase() === keyword.toLowerCase());

            const out = document.getElementById('search-output');
            if(res) {
                const d = res.data();
                document.getElementById('res-name').innerText = d.name;
                document.getElementById('res-mcq').innerText = d.mcqScore?.toFixed(1) + "/3.0";
                document.getElementById('res-essay').innerText = d.essayScore !== undefined ? d.essayScore + "/7.0" : "?";
                document.getElementById('res-comment').innerText = d.status === 'ƒê√£ ch·∫•m' ? (d.comment || "Kh√¥ng c√≥ nh·∫≠n x√©t.") : "‚è≥ C√¥ ƒëang ch·∫•m ph·∫ßn t·ª± lu·∫≠n, em ch·ªù nh√©!";
                out.classList.remove('hidden');
            } else { alert("Kh√¥ng t√¨m th·∫•y h·ªçc sinh n√†y."); }
        };

        // GI√ÅO VI√äN: L·∫Øng nghe d·ªØ li·ªáu
        let allSubmissions = [];
        function listenForData() {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'submissions'), (snap) => {
                allSubmissions = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAdminTable();
            });
        }

        function renderAdminTable() {
            const tbody = document.getElementById('admin-table');
            allSubmissions.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
            tbody.innerHTML = allSubmissions.map(s => `
                <tr class="hover:bg-slate-50 transition">
                    <td class="p-4 font-bold text-slate-700">${s.name}</td>
                    <td class="p-4 text-slate-500">${s.class}</td>
                    <td class="p-4 font-black text-blue-600">${s.mcqScore?.toFixed(1)}</td>
                    <td class="p-4">
                        <span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${s.status === 'ƒê√£ ch·∫•m' ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'}">
                            ${s.status === 'ƒê√£ ch·∫•m' ? s.essayScore + ' ƒë' : 'Ch∆∞a ch·∫•m'}
                        </span>
                    </td>
                    <td class="p-4"><button onclick="openGradeModal('${s.id}')" class="bg-slate-800 text-white text-[10px] px-3 py-1 rounded-lg font-bold">CH·∫§M B√ÄI</button></td>
                </tr>
            `).join('');
        }

        window.openGradeModal = (id) => {
            activeGradingId = id;
            const s = allSubmissions.find(x => x.id === id);
            document.getElementById('grade-title').innerText = "Ch·∫•m b√†i: " + s.name;
            document.getElementById('grade-content').innerText = s.essay || "(H·ªçc sinh kh√¥ng n·ªôp l·ªùi gi·∫£i)";
            document.getElementById('grade-value').value = s.essayScore || "";
            document.getElementById('grade-comment').value = s.comment || "";
            document.getElementById('grading-modal').style.display = 'flex';
        };

        window.closeGradeModal = () => document.getElementById('grading-modal').style.display = 'none';

        window.saveFinalGrade = async () => {
            const val = parseFloat(document.getElementById('grade-value').value);
            const cmt = document.getElementById('grade-comment').value;
            if(isNaN(val)) return alert("H√£y nh·∫≠p ƒëi·ªÉm!");

            const btn = document.getElementById('btn-save');
            btn.disabled = true; btn.innerText = "ƒêANG L∆ØU...";

            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'submissions', activeGradingId), {
                    essayScore: val, comment: cmt, status: 'ƒê√£ ch·∫•m'
                });
                closeGradeModal();
                alert("ƒê√£ l∆∞u ƒëi·ªÉm!");
            } catch(e) { alert("L·ªói!"); }
            btn.disabled = false; btn.innerText = "üíæ L∆ØU ƒêI·ªÇM V√Ä PH·∫¢N H·ªíI";
        };

    </script>
</body>
</html>


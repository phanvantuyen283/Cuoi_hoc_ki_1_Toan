import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  onSnapshot, 
  doc, 
  updateDoc, 
  serverTimestamp, 
  query,
  getDocs
} from 'firebase/firestore';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { 
  BookOpen, 
  GraduationCap, 
  Search, 
  CheckCircle2, 
  Clock, 
  User, 
  MessageSquare, 
  Save, 
  X,
  AlertCircle
} from 'lucide-react';

// --- C·∫•u h√¨nh Firebase ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'toan-4-hk1-v2';

export default function App() {
  const [view, setView] = useState('student'); // 'student', 'admin', 'results'
  const [user, setUser] = useState(null);
  const [submissions, setSubmissions] = useState([]);
  const [loading, setLoading] = useState(true);
  
  // Auth & Data Sync
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    const unsubscribeAuth = onAuthStateChanged(auth, setUser);
    return () => unsubscribeAuth();
  }, []);

  useEffect(() => {
    if (!user) return;
    const q = collection(db, 'artifacts', appId, 'public', 'data', 'exams');
    const unsubscribeData = onSnapshot(q, (snapshot) => {
      const data = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      // Sort by time in memory
      data.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
      setSubmissions(data);
      setLoading(false);
    }, (error) => {
      console.error("Firestore Error:", error);
      setLoading(false);
    });
    return () => unsubscribeData();
  }, [user]);

  // UI Components
  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-900">
      {/* Navigation Bar */}
      <nav className="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-slate-200 px-4 py-3">
        <div className="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
          <div className="flex items-center gap-2">
            <div className="bg-blue-600 p-2 rounded-xl text-white">
              <BookOpen size={24} />
            </div>
            <h1 className="font-extrabold text-xl text-slate-800 tracking-tight">EduMath L·ªõp 4</h1>
          </div>
          
          <div className="flex bg-slate-100 p-1 rounded-2xl border border-slate-200">
            <TabBtn active={view === 'student'} onClick={() => setView('student')} icon={<User size={16}/>} label="H·ªçc sinh" />
            <TabBtn active={view === 'results'} onClick={() => setView('results')} icon={<Search size={16}/>} label="Tra c·ª©u" />
            <TabBtn active={view === 'admin'} onClick={() => setView('admin')} icon={<GraduationCap size={16}/>} label="Gi√°o vi√™n" />
          </div>
        </div>
      </nav>

      <main className="max-w-4xl mx-auto p-4 md:p-8">
        {view === 'student' && <StudentView user={user} />}
        {view === 'results' && <ResultsView submissions={submissions} />}
        {view === 'admin' && <AdminView submissions={submissions} loading={loading} />}
      </main>
    </div>
  );
}

// --- Sub-components ---

function TabBtn({ active, onClick, icon, label }) {
  return (
    <button 
      onClick={onClick}
      className={`flex items-center gap-2 px-5 py-2 rounded-xl text-sm font-bold transition-all ${
        active ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-800'
      }`}
    >
      {icon} {label}
    </button>
  );
}

// 1. GIAO DI·ªÜN H·ªåC SINH
function StudentView({ user }) {
  const [formData, setFormData] = useState({ name: '', class: '', essay: '' });
  const [answers, setAnswers] = useState({});
  const [timeLeft, setTimeLeft] = useState(40 * 60);
  const [submitted, setSubmitted] = useState(false);

  useEffect(() => {
    if (submitted) return;
    const timer = setInterval(() => setTimeLeft(prev => prev - 1), 1000);
    if (timeLeft <= 0) handleSubmit();
    return () => clearInterval(timer);
  }, [timeLeft, submitted]);

  const handleSubmit = async () => {
    if (!formData.name || !formData.class) return alert("Em h√£y nh·∫≠p t√™n v√† l·ªõp nh√©!");
    if (!confirm("Em c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i thi kh√¥ng?")) return;

    // Ch·∫•m ƒëi·ªÉm tr·∫Øc nghi·ªám (T·∫°m th·ªùi 3 c√¢u m·∫´u)
    const keys = { q1: 'B', q2: 'B', q3: 'D' };
    let mcqScore = 0;
    Object.keys(keys).forEach(q => { if (answers[q] === keys[q]) mcqScore += 1; });

    const submission = {
      ...formData,
      answers,
      mcqScore: (mcqScore / Object.keys(keys).length) * 3, // Quy v·ªÅ thang 3
      status: 'Ch∆∞a ch·∫•m',
      createdAt: serverTimestamp()
    };

    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'exams'), submission);
      setSubmitted(true);
    } catch (e) { alert("L·ªói g·ª≠i b√†i! Em ki·ªÉm tra m·∫°ng nh√©."); }
  };

  if (submitted) return (
    <div className="bg-white rounded-3xl p-10 text-center shadow-xl border-t-8 border-green-500 animate-in zoom-in duration-300">
      <div className="bg-green-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
        <CheckCircle2 size={48} className="text-green-600" />
      </div>
      <h2 className="text-3xl font-black text-slate-800 mb-2">N·ªôp b√†i th√†nh c√¥ng!</h2>
      <p className="text-slate-500 mb-8 italic">K·∫øt qu·∫£ c·ªßa em ƒë√£ ƒë∆∞·ª£c l∆∞u an to√†n tr√™n h·ªá th·ªëng c·ªßa c√¥.</p>
      <button onClick={() => location.reload()} className="bg-slate-800 text-white px-8 py-3 rounded-2xl font-bold">L√ÄM L·∫†I B√ÄI</button>
    </div>
  );

  return (
    <div className="space-y-8 animate-in fade-in duration-500">
      <header className="text-center mb-10">
        <h2 className="text-3xl font-black text-blue-700 uppercase tracking-tight">Ki·ªÉm Tra H·ªçc K·ª≥ I</h2>
        <div className="mt-4 inline-flex items-center gap-3 bg-red-100 text-red-600 px-6 py-2 rounded-full font-black text-xl border-2 border-red-200">
          <Clock size={24} />
          <span>{Math.floor(timeLeft/60)}:{(timeLeft%60).toString().padStart(2,'0')}</span>
        </div>
      </header>

      <div className="bg-white rounded-3xl p-6 shadow-sm border-2 border-slate-100">
        <h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2"><User size={20}/> TH√îNG TIN C·ª¶A EM</h3>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input type="text" placeholder="H·ªç v√† t√™n..." value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} className="border-2 rounded-xl p-3 outline-none focus:border-blue-500 transition" />
          <input type="text" placeholder="L·ªõp (V√≠ d·ª•: 4B)..." value={formData.class} onChange={e => setFormData({...formData, class: e.target.value})} className="border-2 rounded-xl p-3 outline-none focus:border-blue-500 transition" />
        </div>
      </div>

      <div className="space-y-6">
        <QuestionBox num={1} text="Gi√° tr·ªã c·ªßa ch·ªØ s·ªë 8 trong s·ªë 28 471 539 l√†:" options={['80 000', '8 000 000', '80 000 000', '800 000']} value={answers.q1} onChange={v => setAnswers({...answers, q1: v})} />
        <QuestionBox num={2} text="T·ªïng l√† 100, hi·ªáu l√† 20. S·ªë l·ªõn l√†:" options={['40', '60', '120', '80']} value={answers.q2} onChange={v => setAnswers({...answers, q2: v})} />
        <QuestionBox num={3} text="48 th√°ng = ...... nƒÉm. S·ªë c·∫ßn ƒëi·ªÅn l√†:" options={['1', '2', '3', '4']} value={answers.q3} onChange={v => setAnswers({...answers, q3: v})} />
        
        <div className="bg-white p-6 rounded-3xl border-l-8 border-emerald-500 shadow-sm">
          <p className="font-bold text-lg mb-2 text-emerald-700 uppercase">Ph·∫ßn T·ª± Lu·∫≠n (7 ƒëi·ªÉm)</p>
          <p className="text-sm text-slate-500 mb-4 italic">B√†i to√°n: ƒê√°m ƒë·∫•t HCN c√≥ n·ª≠a chu vi 180m, chi·ªÅu r·ªông k√©m chi·ªÅu d√†i 24m. T√≠nh di·ªán t√≠ch?</p>
          <textarea 
            value={formData.essay} 
            onChange={e => setFormData({...formData, essay: e.target.value})}
            className="w-full p-4 border-2 rounded-2xl h-48 focus:border-emerald-500 outline-none transition" 
            placeholder="Em tr√¨nh b√†y b√†i gi·∫£i ·ªü ƒë√¢y..."
          />
        </div>
      </div>

      <button onClick={handleSubmit} className="w-full bg-blue-600 text-white font-black py-5 rounded-3xl text-2xl shadow-xl hover:scale-[1.02] transition active:scale-95">üöÄ N·ªòP B√ÄI THI</button>
    </div>
  );
}

function QuestionBox({ num, text, options, value, onChange }) {
  const optLabels = ['A', 'B', 'C', 'D'];
  return (
    <div className="bg-white p-6 rounded-3xl border-l-8 border-blue-500 shadow-sm">
      <p className="font-bold text-slate-800 text-lg mb-4">C√¢u {num}. {text}</p>
      <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
        {options.map((opt, idx) => (
          <label key={idx} className={`flex items-center gap-3 p-4 border-2 rounded-2xl cursor-pointer transition-all ${value === optLabels[idx] ? 'bg-blue-50 border-blue-500 ring-4 ring-blue-100' : 'hover:bg-slate-50 border-slate-100'}`}>
            <input type="radio" className="hidden" name={`q${num}`} value={optLabels[idx]} checked={value === optLabels[idx]} onChange={e => onChange(e.target.value)} />
            <span className={`w-8 h-8 rounded-full flex items-center justify-center font-bold ${value === optLabels[idx] ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-400'}`}>{optLabels[idx]}</span>
            <span className={value === optLabels[idx] ? 'font-bold text-blue-700' : ''}>{opt}</span>
          </label>
        ))}
      </div>
    </div>
  );
}

// 2. GIAO DI·ªÜN TRA C·ª®U
function ResultsView({ submissions }) {
  const [keyword, setKeyword] = useState('');
  const [found, setFound] = useState(null);

  const handleSearch = () => {
    const res = submissions.find(s => s.name.toLowerCase() === keyword.toLowerCase());
    setFound(res || 'none');
  };

  return (
    <div className="max-w-md mx-auto py-10 animate-in slide-in-from-bottom duration-500">
      <div className="bg-white rounded-3xl p-8 shadow-xl border-t-8 border-indigo-500">
        <h2 className="text-2xl font-black text-indigo-700 text-center mb-6">üîç TRA C·ª®U ƒêI·ªÇM</h2>
        <div className="flex gap-2 mb-8">
          <input type="text" placeholder="Nh·∫≠p t√™n em..." value={keyword} onChange={e => setKeyword(e.target.value)} className="flex-grow p-4 border-2 rounded-2xl outline-none focus:border-indigo-500" />
          <button onClick={handleSearch} className="bg-indigo-600 text-white p-4 rounded-2xl"><Search/></button>
        </div>

        {found === 'none' && <p className="text-center text-red-500 font-bold">‚ùå Kh√¥ng t√¨m th·∫•y b√†i l√†m c·ªßa em.</p>}
        
        {found && found !== 'none' && (
          <div className="bg-slate-50 rounded-2xl p-6 border border-slate-200">
            <h3 className="text-xl font-black text-slate-800 text-center mb-4">{found.name}</h3>
            <div className="grid grid-cols-2 gap-4 mb-6">
              <div className="bg-white p-3 rounded-xl text-center border shadow-sm">
                <p className="text-[10px] font-bold text-slate-400 uppercase">Tr·∫Øc nghi·ªám</p>
                <p className="text-2xl font-black text-blue-600">{found.mcqScore?.toFixed(1)}/3.0</p>
              </div>
              <div className="bg-white p-3 rounded-xl text-center border shadow-sm">
                <p className="text-[10px] font-bold text-slate-400 uppercase">T·ª± lu·∫≠n</p>
                <p className="text-2xl font-black text-emerald-600">{found.essayScore !== undefined ? found.essayScore : '?'}</p>
              </div>
            </div>
            <div className="bg-white p-4 rounded-xl text-sm italic text-slate-500 border">
              {found.status === 'ƒê√£ ch·∫•m' ? (found.comment || "Gi√°o vi√™n kh√¥ng nh·∫≠n x√©t.") : "‚è≥ C√¥ ƒëang ch·∫•m b√†i, em ch·ªù nh√©!"}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

// 3. GIAO DI·ªÜN GI√ÅO VI√äN
function AdminView({ submissions, loading }) {
  const [grading, setGrading] = useState(null);

  const handleSaveGrade = async (grade, comment) => {
    try {
      const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'exams', grading.id);
      await updateDoc(docRef, { essayScore: parseFloat(grade), comment, status: 'ƒê√£ ch·∫•m' });
      setGrading(null);
      alert("ƒê√£ l∆∞u ƒëi·ªÉm th√†nh c√¥ng!");
    } catch (e) { alert("L·ªói l∆∞u ƒëi·ªÉm!"); }
  };

  return (
    <div className="animate-in fade-in duration-500">
      <header className="flex justify-between items-center mb-8">
        <h2 className="text-2xl font-black text-slate-800 uppercase tracking-tight">S·ªï ƒêi·ªÉm ƒêi·ªán T·ª≠</h2>
        <div className="text-xs font-bold text-blue-500 bg-blue-50 px-3 py-1 rounded-full animate-pulse">‚óè ƒêang k·∫øt n·ªëi Live</div>
      </header>

      {loading ? (
        <div className="text-center py-20">ƒêang t·∫£i d·ªØ li·ªáu b√†i l√†m...</div>
      ) : (
        <div className="bg-white rounded-3xl shadow-lg border overflow-hidden">
          <table className="w-full text-left">
            <thead className="bg-slate-50 border-b text-xs font-black text-slate-500 uppercase tracking-widest">
              <tr>
                <th className="p-4">H·ªçc sinh</th>
                <th className="p-4">L·ªõp</th>
                <th className="p-4">ƒêi·ªÉm TN</th>
                <th className="p-4">T·ª± lu·∫≠n</th>
                <th className="p-4">Thao t√°c</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-slate-100">
              {submissions.map(s => (
                <tr key={s.id} className="hover:bg-slate-50 transition">
                  <td className="p-4 font-bold text-slate-700">{s.name}</td>
                  <td className="p-4 text-slate-500">{s.class}</td>
                  <td className="p-4 font-black text-blue-600">{s.mcqScore?.toFixed(1)}</td>
                  <td className="p-4">
                    <span className={`px-2 py-1 rounded text-[10px] font-bold uppercase ${s.status === 'ƒê√£ ch·∫•m' ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'}`}>
                      {s.status === 'ƒê√£ ch·∫•m' ? `${s.essayScore}/7.0` : 'Ch∆∞a ch·∫•m'}
                    </span>
                  </td>
                  <td className="p-4"><button onClick={() => setGrading(s)} className="bg-slate-800 text-white text-xs px-4 py-2 rounded-xl font-bold">Ch·∫•m b√†i</button></td>
                </tr>
              ))}
            </tbody>
          </table>
          {submissions.length === 0 && <div className="p-10 text-center text-slate-400">Ch∆∞a c√≥ b√†i l√†m n√†o n·ªôp l√™n h·ªá th·ªëng.</div>}
        </div>
      )}

      {grading && <GradeModal data={grading} onClose={() => setGrading(null)} onSave={handleSaveGrade} />}
    </div>
  );
}

function GradeModal({ data, onClose, onSave }) {
  const [grade, setGrade] = useState(data.essayScore || '');
  const [comment, setComment] = useState(data.comment || '');

  return (
    <div className="fixed inset-0 bg-slate-900/60 z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
      <div className="bg-white w-full max-w-xl rounded-3xl shadow-2xl overflow-hidden animate-in zoom-in duration-300">
        <div className="bg-slate-800 p-6 text-white flex justify-between items-center">
          <h3 className="text-xl font-bold">Ch·∫•m b√†i: {data.name}</h3>
          <button onClick={onClose}><X/></button>
        </div>
        <div className="p-8">
          <label className="text-xs font-bold text-slate-400 uppercase">B√†i l√†m c·ªßa em:</label>
          <div className="bg-slate-50 p-4 rounded-2xl border text-sm italic text-slate-600 mb-6 mt-2 max-h-40 overflow-y-auto whitespace-pre-wrap">{data.essay || "(ƒê·ªÉ tr·ªëng)"}</div>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label className="text-xs font-bold text-slate-400 uppercase">ƒêi·ªÉm (0 - 7):</label>
              <input type="number" step="0.25" value={grade} onChange={e => setGrade(e.target.value)} className="w-full p-4 bg-blue-50 border-2 rounded-2xl font-black text-blue-700" />
            </div>
            <div>
              <label className="text-xs font-bold text-slate-400 uppercase">L·ªùi nh·∫≠n x√©t:</label>
              <input type="text" value={comment} onChange={e => setComment(e.target.value)} className="w-full p-4 border-2 rounded-2xl" placeholder="L√†m b√†i t·ªët..." />
            </div>
          </div>
          <button onClick={() => onSave(grade, comment)} className="w-full mt-8 bg-blue-600 text-white font-black py-4 rounded-2xl flex items-center justify-center gap-2 shadow-lg shadow-blue-200"><Save size={20}/> L∆ØU ƒêI·ªÇM V√Ä PH·∫¢N H·ªíI</button>
        </div>
      </div>
    </div>
  );
}

